require 'spec_helper'

describe ShipmentsController do
end

describe Kuaidi100Notifier do
  # WARNING: make sure modify sender_phone in db before testing
  before(:each) do
    @identifier = 'SH1303190013'
    @raw_post = "param=%7B%22message%22%3A%22%22%2C%22status%22%3A%22shutdown%22%2C%22lastResult%22%3A%7B%22message%22%3A%22ok%22%2C%22state%22%3A%223%22%2C%22data%22%3A%5B%7B%22context%22%3A%22%E5%8C%97%E4%BA%AC%3A%E5%B7%B2%E9%80%81%E8%BE%BE%22%2C%22time%22%3A%222013-03-20+14%3A34%3A42%22%2C%22ftime%22%3A%222013-03-20+14%3A34%3A42%22%7D%2C%7B%22context%22%3A%22%E5%8C%97%E4%BA%AC%3A%E8%B4%A7%E4%BB%B6%E5%B7%B2%E8%A3%85%E8%BD%A6%EF%BC%8C%E6%B4%BE%E9%80%81%E9%80%94%E4%B8%AD%22%2C%22time%22%3A%222013-03-20+11%3A53%3A23%22%2C%22ftime%22%3A%222013-03-20+11%3A53%3A23%22%7D%2C%7B%22context%22%3A%22%E5%8C%97%E4%BA%AC%3A%E4%BD%8D%E4%BA%8E%E5%BD%93%E5%9C%B0%E7%9A%84%E8%81%94%E9%82%A6%E5%BF%AB%E9%80%92%E9%80%92%E9%80%81%E7%AB%99%22%2C%22time%22%3A%222013-03-20+10%3A48%3A08%22%2C%22ftime%22%3A%222013-03-20+10%3A48%3A08%22%7D%2C%7B%22context%22%3A%22%E5%8C%97%E4%BA%AC%3A%E8%B4%A7%E4%BB%B6%E4%BE%8B%E5%A4%96%E7%8A%B6%E6%80%81%22%2C%22time%22%3A%222013-03-20+10%3A48%3A00%22%2C%22ftime%22%3A%222013-03-20+10%3A48%3A00%22%7D%2C%7B%22context%22%3A%22%E5%8C%97%E4%BA%AC%3A%E7%A6%BB%E5%BC%80%E8%81%94%E9%82%A6%E5%BF%AB%E9%80%92%E5%B7%A5%E4%BD%9C%E5%9C%B0%E7%82%B9%22%2C%22time%22%3A%222013-03-20+07%3A50%3A02%22%2C%22ftime%22%3A%222013-03-20+07%3A50%3A02%22%7D%2C%7B%22context%22%3A%22%E6%9D%AD%E5%B7%9E%3A%E8%B4%A7%E4%BB%B6%E4%BE%8B%E5%A4%96%E7%8A%B6%E6%80%81%22%2C%22time%22%3A%222013-03-20+05%3A00%3A00%22%2C%22ftime%22%3A%222013-03-20+05%3A00%3A00%22%7D%2C%7B%22context%22%3A%22%E6%9D%AD%E5%B7%9E%3A%E7%A6%BB%E5%BC%80%E8%81%94%E9%82%A6%E5%BF%AB%E9%80%92%E5%B7%A5%E4%BD%9C%E5%9C%B0%E7%82%B9%22%2C%22time%22%3A%222013-03-20+03%3A47%3A49%22%2C%22ftime%22%3A%222013-03-20+03%3A47%3A49%22%7D%2C%7B%22context%22%3A%22%E6%9D%AD%E5%B7%9E%3A%E5%88%B0%E8%BE%BE%E8%81%94%E9%82%A6%E5%BF%AB%E9%80%92%E5%B7%A5%E4%BD%9C%E5%9C%B0%E7%82%B9%22%2C%22time%22%3A%222013-03-19+22%3A24%3A31%22%2C%22ftime%22%3A%222013-03-19+22%3A24%3A31%22%7D%2C%7B%22context%22%3A%22%E4%B8%8A%E6%B5%B7%3A%E5%B7%B2%E7%A6%BB%E5%BC%80%E5%8F%91%E4%BB%B6%E5%9C%B0%22%2C%22time%22%3A%222013-03-19+18%3A59%3A37%22%2C%22ftime%22%3A%222013-03-19+18%3A59%3A37%22%7D%2C%7B%22context%22%3A%22%E4%B8%8A%E6%B5%B7%3A%E5%B7%B2%E5%8F%96%E4%BB%B6%22%2C%22time%22%3A%222013-03-19+16%3A42%3A55%22%2C%22ftime%22%3A%222013-03-19+16%3A42%3A55%22%7D%5D%2C%22status%22%3A%22200%22%2C%22com%22%3A%22lianbangkuaidi%22%2C%22nu%22%3A%22120718684559%22%2C%22ischeck%22%3A%221%22%2C%22condition%22%3A%22F00%22%7D%2C%22billstatus%22%3A%22check%22%7D"
  end

  it 'should call sending sms correctly' do
    sms = stub('Sms')
    sms.stub(:confirm_order_user_sms).and_return(true)
    sms.should_receive(:confirm_order_user_sms).once

    kuaidi100_notifier = Kuaidi100Notifier.new(@identifier, @raw_post)
    kuaidi100_notifier.update_shipment
  end

end